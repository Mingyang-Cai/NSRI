---
title: "Two factors model with 5 modifications"
author: "Mingyang Cai"
date: ""
output: 
   html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    number_sections: false
---
  
<style type="text/css">
  
body{ /* Normal  */
  font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 18px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
  font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
  font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
  font-size: 14px;
}
</style>


---

# Packages used
The following packages are used.  
```{r message=FALSE, warning=FALSE}
library(dplyr)    # Data manipulation
library(mice)     # Data imputation
library(magrittr) # Pipes
library(purrr)    # Functional programming
library(ggplot2)  # Plotting device
library(lavaan)   # Latent variable analysis
library(psych)    # Factor analysis
library(polycor)  # Polychoric correlation
library(GPArotation) #Rotation 
library(lavaanPlot) 
```

---

We use the two factors model with 5 modifications and keep items with over 20% NA answers. In this simulation, all 7-likert QRP and RRP items are treated as catergorical variables. Majority of `NA`s are still replaced by `1`. However, to make sure that every level of the categorical variables is represented in each subgroup, we replace some `NA` with other values. For example, in the disciplinary field `Soc & Beh`, the item `QCiteSource` has no observations in the level `7`. We select one sample in `Soc & Beh` whose value of `QCiteSource` is not applicable and replace `NA` with `7`.   

---

# Read in the data file
We load all workspaces from the `\Workspaces\` directory in the project's root.
```{r}
load("../../../../../Workspaces/1. Data import and preparation.Rdata")
load("../../../../../Workspaces/2. Data inspection.Rdata")
load("../../../../../Workspaces/3. Data imputation.Rdata")
load("../../../../../Workspaces/5. Preparation Imputed Datasets.Rdata")
```

---

# Setting the RNG seed
```{r}
set.seed(123)
```

---

# Invariance test based on disciplinary field
```{r}
rrp <- c("RDisclFunds", "RCorrectPub", "RAuthorship", "ROpenData", "RKeepRecord", 
         "RPreReg", "RDataManage", "ROpenAccess", "RCiteSource", "ROpenCode", "RErrorCheck")
qrp <- c("QAttention", "QSupervision", "QResDesign", "QUnfairRev", "QUnsubstClaims", 
         "QCiteSource", "QResNotes", "QConcealDetails", "QNoReSubmit", "QConcealFlaws", "QSelectCites")


d50 <- d50 %>% 
  map(select, -all_of(rrp), -all_of(qrp))



#QCiteSource (7)
row.num <- which(complete(d50[[1]])$Field == "Soc & Beh" & complete(d50[[1]])$QCiteSource_raw == 0) %>% min()
d50 <- d50 %>% map(~.x %>% 
                     mutate(QCiteSource_raw = replace(QCiteSource_raw, row.num, 7)))
dat <- complete(d50[[1]])%>% filter(Field == "Soc & Beh") 

#QCiteSource (7)
row.num <- which(complete(d50[[1]])$Field == "Eng & Nat" & complete(d50[[1]])$QCiteSource_raw == 0) %>% min()
d50 <- d50 %>% map(~.x %>% 
                     mutate(QCiteSource_raw = replace(QCiteSource_raw, row.num, 7)))
dat <- complete(d50[[1]])%>% filter(Field == "Eng & Nat")

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate_at(vars(!!!syms(paste0(rrp, "_raw"))), list(r = ~ recode(., `0` = 1))) %>% 
        rename_at(vars(ends_with(("_raw_r"))), ~ gsub("_raw_r", "", .x)) %>% 
        mutate_at(vars(!!!syms(paste0(qrp, "_raw"))), list(q = ~ recode(., `0` = 1))) %>% 
        rename_at(vars(ends_with(("_raw_q"))), ~ gsub("_raw_q", "", .x))) 

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate(RRP_ave = rowMeans(cbind(!!!syms(rrp)), na.rm = T)) %>% 
        mutate(QRP_ave = rowMeans(cbind(!!!syms(qrp)), na.rm = T))) 

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate(QRP_1 = rowSums(cbind(!!!syms(qrp)) > 4)) %>% 
        mutate(QRP_1 = if_else(QRP_1 == 0, 0, 1)))

d50 <- d50 %>% 
  map(~.x %>% 
        mutate(RR_sum = rowSums(cbind(RRfabr, RRfals))))




Model.2.modi <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites 
                 + RR_sum
                 + RErrorCheck + RCiteSource
            RRP =~ RDisclFunds + RCorrectPub + RAuthorship + ROpenData 
                 + RKeepRecord + RPreReg + RDataManage + ROpenAccess 
                 + RCiteSource + ROpenCode + RErrorCheck 
                 + QNoReSubmit + QConcealFlaws
                 
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode 
            QCiteSource ~~   RCiteSource

'


#configural invariance
dat <- complete(d50[[1]])%>% filter(Field != "Arts & Hum")
Model.2.1 <- cfa(Model.2.modi, data = dat, group = "Field", 
                 ordered = c("RDisclFunds", "RCorrectPub", "RAuthorship", 
                             "ROpenData", "RKeepRecord", "RPreReg", 
                             "RDataManage", "ROpenAccess", "RCiteSource", 
                             "ROpenCode", "RErrorCheck", "QAttention", 
                             "QSupervision", "QResDesign", "QUnfairRev", 
                             "QUnsubstClaims", "QCiteSource", "QResNotes", 
                             "QConcealDetails", "QNoReSubmit", "QConcealFlaws", 
                             "QSelectCites", "RR_sum"))

Model.2.2 <- cfa(Model.2.modi, data = dat, group = "Field", 
                 ordered = c("RDisclFunds", "RCorrectPub", "RAuthorship", 
                             "ROpenData", "RKeepRecord", "RPreReg", 
                             "RDataManage", "ROpenAccess", "RCiteSource", 
                             "ROpenCode", "RErrorCheck", "QAttention", 
                             "QSupervision", "QResDesign", "QUnfairRev", 
                             "QUnsubstClaims", "QCiteSource", "QResNotes", 
                             "QConcealDetails", "QNoReSubmit", "QConcealFlaws", 
                             "QSelectCites", "RR_sum"), group.equal = "loadings")

Model.2.3 <- cfa(Model.2.modi, data = dat, group = "Field", 
                 ordered = c("RDisclFunds", "RCorrectPub", "RAuthorship", 
                             "ROpenData", "RKeepRecord", "RPreReg", 
                             "RDataManage", "ROpenAccess", "RCiteSource", 
                             "ROpenCode", "RErrorCheck", "QAttention", 
                             "QSupervision", "QResDesign", "QUnfairRev", 
                             "QUnsubstClaims", "QCiteSource", "QResNotes", 
                             "QConcealDetails", "QNoReSubmit", "QConcealFlaws", 
                             "QSelectCites", "RR_sum"), 
                 group.equal = c("intercepts", "loadings"))
summary(Model.2.1, fit.measures = TRUE)
lavTestLRT(Model.2.1, Model.2.2, Model.2.3)
```
The CFI of the configural invariance model is 0.92. So I think the configural invariance model fits well. Both p-values for model comparison tests are significant. Thus, we may conclude that weak invariance and strong invariance are not supported in this dataset.
