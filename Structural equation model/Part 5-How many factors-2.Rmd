---
title: "Part 5-How many factors-2"
author: "Mingyang Cai"
date: ""
output: 
   html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    number_sections: false
---
  
<style type="text/css">
  
body{ /* Normal  */
  font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 18px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
  font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
  font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
  font-size: 14px;
}
</style>

---

Part 5: Structural equation model (MIMIC SEM) How many factors?  
Keep 0 scores (Not Applicable) in the raw RRP/QRP variables. 

---

# Packages used
The following packages are used.  
```{r message=FALSE, warning=FALSE}
library(dplyr)    # Data manipulation  
library(mice)     # Data imputation  
library(magrittr) # Pipes  
library(purrr)    # Functional programming  
library(ggplot2)  # Plotting device  
library(lavaan)   # Latent variable analysis  
library(psych)    # Factor analysis  
library(polycor)  # Polychoric correlation  
library(GPArotation) #Rotation   
```

---

# Read in the data file
I load all workspaces from the `\Workspaces\` directory in the project's root.
```{r}
load("../Workspaces/1. Data import and preparation.Rdata")
load("../Workspaces/2. Data inspection.Rdata")
load("../Workspaces/3. Data imputation.Rdata")
load("../Workspaces/5. Preparation Imputed Datasets.Rdata")
```

---

# Setting the RNG seed
```{r}
set.seed(123)
```

---

# Keep 0 scores (Not Applicable) in the raw RRP/QRP variables and combine two dichotomous misconduct items (`RRfabr` and `RRfals`) 
```{r}
rrp <- c("RDisclFunds", "RCorrectPub", "RAuthorship", "ROpenData", "RKeepRecord", 
         "RPreReg", "RDataManage", "ROpenAccess", "RCiteSource", "ROpenCode", "RErrorCheck")
qrp <- c("QAttention", "QSupervision", "QResDesign", "QUnfairRev", "QUnsubstClaims", 
         "QCiteSource", "QResNotes", "QConcealDetails", "QNoReSubmit", "QConcealFlaws", "QSelectCites")

d50 <- d50 %>% 
  map(select, -all_of(rrp), -all_of(qrp))

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate_at(vars(!!!syms(paste0(rrp, "_raw"))), list(r = ~ recode(., `0` = 0))) %>% 
        rename_at(vars(ends_with(("_raw_r"))), ~ gsub("_raw_r", "", .x)) %>% 
        mutate_at(vars(!!!syms(paste0(qrp, "_raw"))), list(q = ~ recode(., `0` = 0))) %>% 
        rename_at(vars(ends_with(("_raw_q"))), ~ gsub("_raw_q", "", .x))) 

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate(RRP_ave = rowMeans(cbind(!!!syms(rrp)), na.rm = T)) %>% 
        mutate(QRP_ave = rowMeans(cbind(!!!syms(qrp)), na.rm = T))) 

d50 <- d50 %>% 
  map(~ .x %>% 
        mutate(QRP_1 = rowSums(cbind(!!!syms(qrp)) > 4)) %>% 
        mutate(QRP_1 = if_else(QRP_1 == 0, 0, 1)))

d50 <- d50 %>% 
  map(~.x %>% 
        mutate(RR_sum = rowSums(cbind(RRfabr, RRfals))))
```

---

# Test the model with one factor
```{r}
Model.1 <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites         
                 + RDisclFunds + RCorrectPub + RAuthorship + ROpenData 
                 + RKeepRecord + RPreReg + RDataManage + ROpenAccess 
                 + RCiteSource + ROpenCode + RErrorCheck           
                 + RR_sum  
                 
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode
'
fit.model.1 <- cfa(Model.1, data = complete(d50[[1]]), estimator = "WLSMV")
summary(fit.model.1, fit.measures = TRUE)
```
CFI is 0.75.

---

#Five modifications to improve Model 1
```{r}
modificationindices(fit.model.1, sort. = TRUE, maximum.number = 5)
Model.1.modi <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites         
                 + RDisclFunds + RCorrectPub + RAuthorship + ROpenData 
                 + RKeepRecord + RPreReg + RDataManage + ROpenAccess 
                 + RCiteSource + ROpenCode + RErrorCheck           
                 + RR_sum  
                 
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode
            RKeepRecord ~~ RDataManage
            QUnsubstClaims ~~ QResNotes
            QResDesign ~~ QUnsubstClaims
            RCiteSource ~~ RErrorCheck
            QUnsubstClaims ~~ QSelectCites
            
'
fit.model.1.modi <- cfa(Model.1.modi, data = complete(d50[[1]]), estimator = "WLSMV")
summary(fit.model.1.modi, fit.measures = TRUE)


```
CFI increases to 0.78.

---

# Test the model with two factors
```{r}
Model.2 <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites 
                 + RR_sum
            RRP =~ RDisclFunds + RCorrectPub + RAuthorship + ROpenData 
                 + RKeepRecord + RPreReg + RDataManage + ROpenAccess 
                 + RCiteSource + ROpenCode + RErrorCheck 
                 
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode 

'
fit.model.2 <- cfa(Model.2, data = complete(d50[[1]]), estimator = "WLSMV", std.lv=TRUE)
summary(fit.model.2, fit.measures = TRUE)

```
The CFI is 0.88.

---

# Five modifications to improve Model 2
```{r}
modificationindices(fit.model.2, sort. = TRUE, maximum.number = 5)
Model.2.modi <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites 
                 + RR_sum
            RRP =~ RDisclFunds + RCorrectPub + RAuthorship + ROpenData 
                 + RKeepRecord + RPreReg + RDataManage + ROpenAccess 
                 + RCiteSource + ROpenCode + RErrorCheck 
                 + QNoReSubmit + QUnsubstClaims + QUnfairRev
                 
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode 
            RKeepRecord ~~ RDataManage
            QNoReSubmit ~~ ROpenCode

'
fit.model.2.modi <- cfa(Model.2.modi, data = complete(d50[[1]]), estimator = "WLSMV", std.lv=TRUE)
summary(fit.model.2.modi, fit.measures = TRUE)
```
The CFI now is 0.91. 


---
 
# Investigate model with three factors with explanatory factor analysis
```{r}
data.for.fa <- complete(d50[[1]])[c(118 : 140)]
hetcor(data.for.fa, ML = TRUE)$correlations

fafit.free <- complete(d50[[1]]) %>% extract(c(118 : 140)) %>% hetcor(ML = TRUE) %>% use_series(correlations) %>% fa(., nfactors = 23, rotate = "none")
n.factors <- length(fafit.free$e.values)
data.frame(factor.num = as.factor(1 : length(fafit.free$e.values)),
           Eigenvalue = fafit.free$e.values) %>% ggplot(aes(x = factor.num, 
                                                            y = Eigenvalue, 
                                                            group = 1)) + 
  geom_point() + geom_line() + xlab("Number of factors") + 
  ylab("Initial eigenvalue") + ggtitle("Scree plot")

efa.fit.3 <- complete(d50[[1]]) %>% extract(c(118 : 140)) %>% hetcor(ML = TRUE) %>% use_series(correlations) %>% fa(., nfactors = 3, rotate = "promax")
print(efa.fit.3)
fa.diagram(efa.fit.3)
```

The factor path plot shows the structure of the model with three factors. `MR2` is the QRP factor, `MR1` is one RRP factor (RRP.1) and `MR3` is the other RRP factor (RRP.2). In this plot, the variable `QUnfairRev` is an indicator of RRP.1. However, since the loading of `QUnfairRev` is 0.32 on RRP.1 and is 0.3 on QRP. I still treat `QUnfairRev` as an indicator of RRP. Similarly, because the prior assumption of correlated residuals between open data and open code, I treat `ROpenData` and `ROpenCode` as indicators of RRP.2. In fact, the plot shows that these two variables are indicators of different RRP factors. 

---

# Perform confirmatory factor analysis with three factors
```{r}
Model.3 <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites 
                 + RR_sum
            RRP.1 =~ RDisclFunds + RCorrectPub + RAuthorship  + ROpenAccess 
                   + RCiteSource  + RErrorCheck
            RRP.2 =~ RKeepRecord + RDataManage + ROpenData + ROpenCode     
                   + RPreReg
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode 
            RRP.1 ~~ RRP.2
    

'
fit.model.3 <- cfa(Model.3, data = complete(d50[[1]]), estimator = "WLSMV")
summary(fit.model.3, fit.measures = TRUE)

```
The CFI is 0.89.

---

# Five modifications to improve Model 3
```{r}
modificationindices(fit.model.3, sort. = TRUE, maximum.number = 5)

Model.3.modi <- '#latent variable definition
            QRP =~ QAttention + QSupervision + QResDesign + QUnfairRev 
                 + QUnsubstClaims + QCiteSource + QResNotes + QConcealDetails 
                 + QNoReSubmit + QConcealFlaws + QSelectCites 
                 + RR_sum
            RRP.1 =~ RDisclFunds + RCorrectPub + RAuthorship  + ROpenAccess 
                   + RCiteSource  + RErrorCheck
                   + QNoReSubmit + QUnfairRev + QUnsubstClaims
            RRP.2 =~ RKeepRecord + RDataManage + ROpenData + ROpenCode     
                   + RPreReg
                   + QNoReSubmit + QUnsubstClaims
            #variance and covariance
            RDisclFunds ~~ RAuthorship
            RCorrectPub ~~ RErrorCheck
            ROpenData ~~ ROpenCode 
            RRP.1 ~~ RRP.2
    

'

fit.model.3.modi <- cfa(Model.3.modi, data = complete(d50[[1]]), estimator = "WLSMV")
summary(fit.model.3.modi, fit.measures = TRUE)

```
The CFI is now 0.92.
